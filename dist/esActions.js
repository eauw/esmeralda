// Generated by CoffeeScript 2.3.2
(function() {
  var createAlias, createIndex, deleteAlias, deleteAliasIfExists, deleteIndices, existsAlias, findIndices, getAlias, mapIndicesToAliases, stop;

  ({stop, mapIndicesToAliases} = require("./utils"));

  createIndex = function(client) {
    return function(index) {
      return client.indices.create({index});
    };
  };

  deleteAlias = function(client) {
    return function(name) {
      console.log("Deleting alias '%s'.", name);
      return client.indices.deleteAlias({
        index: "_all",
        name
      });
    };
  };

  createAlias = function(client) {
    return function(name, index) {
      console.log("Creating alias '%s' pointing to '%s'.", name, index);
      return client.indices.putAlias({name, index});
    };
  };

  existsAlias = function(client) {
    return function(name) {
      return client.indices.existsAlias({name});
    };
  };

  deleteAliasIfExists = function(client) {
    return function(name) {
      return existsAlias(client)(name).then(function(exists) {
        if (exists) {
          return deleteAlias(client)(name);
        } else {
          console.log("Alias '%s' does not exist.", name);
          return exists;
        }
      });
    };
  };

  findIndices = function(client) {
    return function(index) {
      return client.indices.exists({index}).then(function(exists) {
        if (!exists) {
          console.error("No indices found matching '%{index}'", index);
          // TODO: Soll das hier abgefangen werden??
          stop(1);
        }
        return client.indices.get({index});
      }).then(function(result) {
        var count;
        count = Object.keys(result).length;
        if (count === 0) {
          console.log("Found no indices matching '%s'.", index);
          stop();
        }
        console.log("Found %d index/indices matching '%s':", count, index);
        return mapIndicesToAliases(result);
      });
    };
  };

  getAlias = function(client) {
    return function(name) {
      return client.indices.getAlias({name});
    };
  };

  deleteIndices = function(client) {
    return function(indices) {
      return client.indices.delete({
        index: Object.keys(indices)
      });
    };
  };

  module.exports = function(client) {
    return {
      createIndex: createIndex(client),
      deleteAlias: deleteAlias(client),
      createAlias: createAlias(client),
      existsAlias: existsAlias(client),
      deleteAliasIfExists: deleteAliasIfExists(client),
      findIndices: findIndices(client),
      getAlias: getAlias(client),
      deleteIndices: deleteIndices(client)
    };
  };

}).call(this);
